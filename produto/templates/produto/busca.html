{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block titulo %}| Listagem de Prefeituras{% endblock titulo %}
{% block conteudo %}
<div class="wrapper">
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
          <div class="container-fluid">
              <div class="row mb-2">
                  <div class="col-sm-6">
                      <h1>Criar Solicitação</h1>
                  </div>
              </div>
          </div><!-- /.container-fluid -->
      </section>

      <!-- Main content -->
      <section class="content">
          <div class="container-fluid">
              <div class="row">
                  <div class="col-12">
                      <div class="card">
                          <div class="card-header">
                              <h3 class="card-title">Adicionar Solicitação</h3>
                          </div>
                          <!-- /.card-header -->
                          <div class="card-body">
                              <form method="post" action="/produto/blank">{% csrf_token %}
                                <input type="hidden" name="objProdutos" id="objProdutos" value="">
                                <div class="form-group w-100">
                                    <label for="autoComplete">Produto:</label>
                                    <input id="autoComplete" type="text" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off" class="form-control">
                                    <small class="form-text text-muted">Escolha seu produto e clique para ser adicionado à solicitação</small>
                                </div>
                                <div class="form-group">
                                  <ul id="result" multiple class="list-group list-group-horizontal-xxl">
                                  </ul>
                                </div>
                                <input type="submit" value="Salvar" class="btn btn-success">
                                  
                              </form>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </section>
<script>
  const resultado = document.getElementById("result");
  const objProdutos = document.getElementById('objProdutos');
  var ob = [];
  const autoCompleteJS = new autoComplete({
    selector: "#autoComplete",
    placeHolder: "Digite um produto...",
    debouce: 300,
    threshold: 3,
    resultsList: {
      maxResults: 10,
    },
    data: {
      src: async (query) => {
        try {
          const source = await fetch(`/produto/search/?search=${query}`);
          const data = await source.json();
          return data.data;
        } catch (error) {
          return error;
        }
      },
      keys: ["nome"],
      cache: false,
    },
    resultsList: {
      element: (list, data) => {
        if (!data.results.length) {
          // Create "No Results" message element
          const message = document.createElement("div");
          // Add class to the created element
          message.setAttribute("class", "no_result");
          // Add message text content
          message.innerHTML = `<span>Sem resultados para "${data.query}"</span>`;
          // Append message element to the results list
          list.prepend(message);
        }
      },
      noResults: true,
    },
    resultItem: {
      highlight: true,
    },
    events: {
      input: {
        selection: (event) => {
          const selection = event.detail.selection.value;
          verify_produto(selection);
          //console.log(objProdutos.value); 
        },
      },
    },
  });

  function verify_produto(item) {
    v = false;
    for( let i = 0; i < ob.length; i++) {
      if (item.id == ob[i].id) {
        v = true
      }
    }
    if (!v) {
      ob.push(item);
      resultado.innerHTML += `<li id="li-${item.id}" class="list-group-item d-flex p-2 bd-highlight justify-content-between">${item.nome}<a href="#" class="btn btn-danger li-produto" onclick=removerProduto('li-${item.id}',${item.id})><i class="fas fa-trash-can"></i></a>`;
      objProdutos.value = add_produto(item);
    }
  }
    ob_temp = '';
  function add_produto(item) {
    ob_temp = '';
    for(let i = 0; i < ob.length; i++){
      ob_temp += `${JSON.stringify(ob[i])},`;
    }
    objProdutos.value = ob_temp;
    //console.log(objProdutos.value)
  }

  function removerProduto(item, id) {
    for(let i = 0; i < ob.length; i++) {
      if (ob[i].id == id) {
         ob.splice(i, 1);
        document.getElementById(item).remove();
        objProdutos.value = JSON.stringify(ob[0]);
      }
    }
    console.log(ob);
  }
  </script>

{% endblock conteudo %}
